#!/bin/bash

LOG_FILE="/var/log/server_maintenance.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

log "üöÄ --- –ù–ê–ß–ê–õ–û –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–Ø ---"

# --- 1. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´ (UBUNTU) ---
# –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ –Ω—É–∂–Ω–æ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Ö–∞–∫–µ—Ä–æ–≤
log "üõ† –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."
export DEBIAN_FRONTEND=noninteractive
apt-get update -q && apt-get upgrade -y -q
apt-get autoremove -y
apt-get clean

# --- 2. –û–ë–ù–û–í–õ–ï–ù–ò–ï MARZBAN (–û–¢–ö–õ–Æ–ß–ï–ù–û –î–õ–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò) ---
# –ú—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º —è–¥—Ä–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–±–æ–µ–≤.
# –ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é - —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ä—É–∫–∞–º–∏.
# log "üê≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Marzban..."
# cd /opt/marzban || exit
# docker compose pull --ignore-pull-failures
# docker compose up -d --build --remove-orphans

# --- 3. –û–ß–ò–°–¢–ö–ê –ú–£–°–û–†–ê ---
log "üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∏—Å–∫–∞ –∏ –ª–æ–≥–æ–≤..."

# –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ "–≤–∏—Å—è—á–∏–µ" –æ–±—Ä–∞–∑—ã (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
docker image prune -f

# –û—á–∏—â–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –∂—É—Ä–Ω–∞–ª (–æ—Å—Ç–∞–≤–ª—è–µ–º 3 –¥–Ω—è)
journalctl --vacuum-time=3d

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ >50MB
find /var/lib/docker/containers/ -type f -name "*.log" -size +50M -exec truncate -s 0 {} \;

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã —Å –¥–∏—Å–∫–∞ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
find /root/backups -type f -name "*.zip" -mtime +30 -delete

log "‚úÖ --- –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û ---"
