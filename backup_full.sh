#!/bin/bash

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–Ω—É–∂–µ–Ω –ø–∞—Ä–æ–ª—å –æ—Ç –ë–î)
source /opt/marzban/.env

# –ü–∞–ø–∫–∞, –∫—É–¥–∞ –∫–ª–∞–¥–µ–º –∞—Ä—Ö–∏–≤—ã
BACKUP_DIR="/root/backups"
mkdir -p $BACKUP_DIR

# –ò–º—è —Ñ–∞–π–ª–∞ —Å –¥–∞—Ç–æ–π
DATE=$(date +"%Y-%m-%d_%H-%M")
ARCHIVE_NAME="Full_Backup_$DATE.zip"

echo "‚è≥ –ù–∞—á–∏–Ω–∞—é —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞..."

# 1. –î–ê–ú–ü –ë–ê–ó–´ –î–ê–ù–ù–´–• (–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ!)
# –ú—ã –≤—ã–≥—Ä—É–∂–∞–µ–º –±–∞–∑—É –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ —Ñ–∞–π–ª .sql, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ —Ü–µ–ª—ã–º–∏
echo "üóÑ –≠–∫—Å–ø–æ—Ä—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö MySQL..."
docker exec marzban-mariadb mysqldump -u marzban -p"$DB_PASSWORD" marzban > /opt/marzban/marzban_db_dump.sql

# 2. –ê–†–•–ò–í–ê–¶–ò–Ø
echo "üì¶ –°–±–æ—Ä —Ñ–∞–π–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤..."

# –ú—ã –∞—Ä—Ö–∏–≤–∏—Ä—É–µ–º:
# - /var/lib/marzban (—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–∏)
# - /opt/marzban (–í–°–Æ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞: –±–æ—Ç, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –∞–¥–≥–∞—Ä–¥, –∫–æ–Ω—Ñ–∏–≥–∏)
#
# –ú—ã –ò–°–ö–õ–Æ–ß–ê–ï–ú (-x):
# - mysql_data/* (–ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏ –¥–∞–º–ø –≤—ã—à–µ, —Å—ã—Ä—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –Ω—É–∂–Ω—ã)
# - *.log (—á—Ç–æ–±—ã –∞—Ä—Ö–∏–≤ –Ω–µ –±—ã–ª –æ–≥—Ä–æ–º–Ω—ã–º)
# - vpn-bot/__pycache__ (–º—É—Å–æ—Ä –ø–∏—Ç–æ–Ω–∞)

zip -r $BACKUP_DIR/$ARCHIVE_NAME \
    /var/lib/marzban \
    /opt/marzban \
    -x "/opt/marzban/mysql_data/*" \
    -x "*.log" \
    -x "*/__pycache__/*" \
    -x "*/.git/*"

# 3. –û–ß–ò–°–¢–ö–ê
# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–∞–º–ø–∞ (–æ–Ω —É–∂–µ –≤–Ω—É—Ç—Ä–∏ zip)
rm /opt/marzban/marzban_db_dump.sql

# (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –£–¥–∞–ª—è–µ–º –±—ç–∫–∞–ø—ã —Å—Ç–∞—Ä—à–µ 14 –¥–Ω–µ–π, —á—Ç–æ–±—ã –Ω–µ –∑–∞–±–∏—Ç—å –¥–∏—Å–∫
find $BACKUP_DIR -type f -name "*.zip" -mtime +14 -delete

echo "‚úÖ –ë—ç–∫–∞–ø –≥–æ—Ç–æ–≤: $BACKUP_DIR/$ARCHIVE_NAME"
echo "üíæ –°–∫–∞—á–∞–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ Terminus (SFTP)"
